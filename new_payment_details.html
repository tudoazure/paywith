<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-GB">

<head>
    <title>Paytm</title>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="robots" content="index, follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    <!-- build:css src/css/style.min.css -->

    <!--<link rel="stylesheet" href="styles/bootstrap.min.css">
    <link rel="stylesheet" href="styles/bootstrap-theme.min.css">-->
    <link rel="stylesheet" href="styles/paywithpaytmdg.css">
    <!-- /build -->

    <!-- build:js config.js -->
    <script src="environment/config.js"></script>
    <!-- /build -->

    <!-- build:js src/js/vendor.min.js -->
    <script src="scripts/vendor/jquery.min.js"></script>
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script> -->
    <script src="scripts/vendor/bootstrap.min.js"></script>
    <script src="scripts/vendor/jquery.form.js"></script>
    <script src="scripts/vendor/spin.min.js"></script>
    <script src="scripts/vendor/bootstrapValidator.js"></script>
    <!-- /build -->

    <script src="new_custom.js"></script>

</head>

<body>

    <!--<form name="product-form" id="product-form" enctype="multipart/form-data" method="post">-->
        <div id="sell-digital" class="row-fluid">
            <div class="span6" id="prod_pay_details">
            </div>
            <div id="preview_img" class="span6">
            </div>
            <div id="viewContainer" class="span6">
                <div id="custom-forms-editable" class="span6">
                <!--<div class="form-group">
                    <p>
                        <input type="email" class="form-control" id="d_email" name="d_email" placeholder="Enter your email id" autocomplete="on">
                    </p> 

                </div> -->
                </div>
                <!--<div class="span6">
                    <p>

                        <button type="submit" class="" id="payNow" style="background: url('assets/images/paywithpaytm.png'); width:238px; height:65px; border:none;"></button>
                    </p>
                </div> -->
            </div>
            

        </div>
    <!--</form>-->


</body>

</html>

<script type="text/javascript">
    /*
     *spinner code
     */
    $(function () {
    
        $('#product-form').bootstrapValidator({
            message: 'This value is not valid',
            submitHandler: function (validator, form) {
    
                console.log("submit handler called");
                _pay_now_submit();
                //form.submit();
            },
            fields: {
                d_email: {
                    message: 'Title is not valid',
                    validators: {
                        notEmpty: {
                            message: 'Please provide an email address'
                        },
                        emailAddress: {
                            message: 'The input is not a valid email address'
                        }
    
                    }
                }
    
    
            }
        });
    
    
        
       
    })
    
    //var pbid = __get_parameter_by_name("pbid");
    var pbid = getParamValue();
    
    var returnUrl = __get_parameter_by_name("return_url");
    
    createCookie("pptm_rt_url", returnUrl, 30);
    
    function getParamValue(){
        var url = window.location.href;
        var myRegexp = new RegExp("product/.*?/(.*?)/");
        var match = myRegexp.exec(url);
        if (typeof match !== 'undefined' && match != null) {
            return match[1];
        } else {
            return __get_parameter_by_name("pbid");
        }
        
        
    }
    var intId = $("#sell-digital div").length;
    
    __get_pay_prod_details(pbid);
    
    $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    })
    
    
    
    function _pay_now_submit() {
        
    
    
        var $inputs = $('#product-form :input');
        console.log($inputs);
        var email = $("#d_email").val();
        var values = {};
        var c_name = {};
        var c_desc = {};
        var cp = {};
        $inputs.each(function () {
            if (this.name != "d_email" && this.name != "title" && this.name != "description" && this.name != "price" && this.name != "currency" && this.name != "") {
                
                values[this.name] = $(this).val();
                cp[$(this).attr("rel")] = $(this).val();
            }
        });
    
        //creating objects of custom parameters
    
    
        var c_params = JSON.stringify(cp);
        
        
    
        $("#sell-digital").html("");
//       $("#sell-digital").css({ // "height": "100px", // "margin-top": "150px" // });

        
        $("#sell-digital").html("<div class=\"text-center\">" +
            "<img src=\""+appConfig.APP_HOST+"assets/images/spinner-md.gif\">" +
        "</div>");
        
        var session_token = readCookie("paytm_session_key");
        var device_type = 'desktop-browser';
        if(device.mobile()){
            device_type = 'mobile-browser';
        }
        var formData = new FormData();
        formData.append("id", pbid);
        formData.append("d_email", email);
        formData.append("custom_params", c_params);
        formData.append("device_type", device_type);
    
        eraseCookie("transaction_id");
         __start_transaction(formData);
        
    
    
    }
    
    /*
     *
     * function to start transaction 
     */
    
    function __start_transaction(data){
        
        $.ajax({
            url: appConfig.API_HOST + appConstants.START_TRANSACTION,
            type: "POST",
            data: data,
            processData: false, // tell jQuery not to process the data
            contentType: false,
            success: function (responseData) {
                
                console.log("start transaction response  data " + responseData);
                
                var txnResponse = $.parseJSON(responseData);
                
                if (txnResponse.status == 0) {
                    console.log("transaction successful" + txnResponse.data.transaction_id);
                    createCookie("dg_transaction_id", txnResponse.data.transaction_id);
                    __finish_transaction(txnResponse.data.transation_id);
                    
                } else {
                    if(txnResponse.status === 121){
                        $("#sell-digital").html("<p class=\"text-center\"><h4>This product is disabled.</h4></p><p class=\"text-center\"><img src=\"" + appConfig.APP_HOST + "assets/images/disabled.jpg" + "\" class=\"img-responsive\"></p>");
                    } else {
                        console.log("reansaction unsuccessful");
                        $("#sell-digital").html("<p>"+txnResponse.message+ "</p>");
                    }
                    
                    
                }
            }
        });
    }
    
    /*
     *
     * function to finish transaction 
     *
     */
        
    function __finish_transaction(transaction_id){
        var session_cookie = readCookie("paytm_session_key");
        
        
        
        if (session_cookie == null) {
            
            window.location.href = appConfig.OAUTH_HOST + "oauth2/authorize?client_id="+appConfig.OAUTH_CLIENT_ID+"&scope=paytm&response_type=code&redirect_uri=" + appConfig.APP_HOST + "authpayresponse.html";
        } else {
                    var device_type = 'desktop-browser'; if(device.mobile()){ device_type = 'mobile-browser'; }

                    var formData = new FormData();
                    var transaction_id = readCookie("dg_transaction_id");
                    formData.append("transaction_id", transaction_id);
                    formData.append("session_token", session_cookie);
                    formData.append("device_type", device_type);
                    
             $.ajax({
            url: appConfig.API_HOST + appConstants.FINISH_TRANSACTION,
            type: "POST",
            data: formData,
            processData: false, // tell jQuery not to process the data
            contentType: false,
            success: function (responseData) {
                
                console.log("finish transaction  response data " + responseData);
                var txnResponse = $.parseJSON(responseData);
                
                if (txnResponse.status == 0) {
                    console.log("transaction successful");
                    if(device.mobile()){
                        $("#sell-digital").html("<div class=\"span6 text-center\"><p>Thank you for your purchase. A link to the file has been emailed to you.</p><p><a href=\"#\" onclick=\"javascript:window.open('','_self').close();\">Close</a></p></div>");        
                    } else {
                        $("#sell-digital").html("<div class=\"span6 text-center\"><p>Thank you for your purchase. A link to the file has been emailed to you.</p></div>");
                    }
                    
                } else if(txnResponse.status == 1001){
                    console.log("insufficient balance");  
                    var form_data = txnResponse.data.html_form;
                    $("#sell-digital").html(form_data);
                } else {
                    console.log("transaction failed");
                    $("#sell-digital").html("<div class=\"span6 text-center\"><p>Thank you for your purchase. A link to the file has been emailed to you.</p></div>");
                    $("#sell-digital").html("<p>"+txnResponse.message+ "</p>");
                 
                }
            }
        });
        }
    }
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
    ga('create', 'UA-48995472-1', 'paytm.com');
    ga('send', 'pageview');
</script>
